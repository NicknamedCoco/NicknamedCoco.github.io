<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="NicknamedCoco"><meta name="copyright" content="NicknamedCoco"><meta name="generator" content="Hexo 6.2.0"><meta name="theme" content="hexo-theme-yun"><title>聊聊多线程(一) | CocoBlog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.3.3/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/@unocss/runtime/mini.global.js"></script><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="https://cdn.wkyes.com/blog/bg/keyi.ico"><link rel="mask-icon" href="https://cdn.wkyes.com/blog/bg/keyi.ico" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"wkyes.com","root":"/","title":["Coco","Coding"],"version":"1.10.2","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false,"src":"/js/search/local-search.js"},"fireworks":{"colors":null},"waline":{"config":{"enable":true,"serverURL":"https://waline.wkyes.com","comment":true,"placeholder":"要文明评论哦, 不然会被打屁屁","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":"zh-cn","visitor":false,"comment_count":true,"emoji":["https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/bilibili/","https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/weibo/","https://fastly.jsdelivr.net/gh/walinejs/emojis@latest/qq/"],"locale":{"placeholder":"填写邮箱，可以收到回复通知哦～","requiredFields":["nick"]},"QMSG_KEY":"29c69c9f11f0812041673f0693f04a4b","QQ_ID":506579631,"AUTHOR_EMAIL":"one.dayinaug@gmail.com","SITE_NAME":"CocoBlog","SITE_URL":"wkyes.com","SMTP_SERVICE":"Gmail","SMTP_USER":"one.dayinaug@gmail.com","SMTP_PASS":"tgy153rfvhu14863","SMTP_SECURE":false,"el":"#waline"},"cdn":"https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.js","dark":"html.dark"},"vendors":{"darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="近况  实习结束了就回到家里，准备毕设和学习多线程了，我还是自制力太差，学习效果不太好，自制力差的原因在于没有认清自己目前所处的阶段，所以才无所事事，在沉沦很多天之后，期间断断续续学习，坦白说没有很好的收获，人啊，一旦没有了目标，心就空了，就容易迷茫，人还是应该有所追求，有目标才有动力。 我一直认为，学习如果没有输出，是很难继续下去的，这就是为什么我写博客的原因，哪怕没人看最近一段时间开始学习多">
<meta property="og:type" content="article">
<meta property="og:title" content="聊聊多线程(一)">
<meta property="og:url" content="https://wkyes.com/2022/01/14/%E8%81%8A%E8%81%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E4%B8%80/index.html">
<meta property="og:site_name" content="CocoBlog">
<meta property="og:description" content="近况  实习结束了就回到家里，准备毕设和学习多线程了，我还是自制力太差，学习效果不太好，自制力差的原因在于没有认清自己目前所处的阶段，所以才无所事事，在沉沦很多天之后，期间断断续续学习，坦白说没有很好的收获，人啊，一旦没有了目标，心就空了，就容易迷茫，人还是应该有所追求，有目标才有动力。 我一直认为，学习如果没有输出，是很难继续下去的，这就是为什么我写博客的原因，哪怕没人看最近一段时间开始学习多">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/1.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/2.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/3.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/4.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/5.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/6.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/7.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/8.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/9.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/10.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/11.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/12.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/13.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/14.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/15.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/16.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/17.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/18.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/19.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/20.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/21.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/22.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/23.png">
<meta property="og:image" content="https://cdn.wkyes.com/blog/thread/thread1/24.png">
<meta property="article:published_time" content="2022-01-14T12:01:51.000Z">
<meta property="article:modified_time" content="2023-06-16T05:40:33.771Z">
<meta property="article:author" content="NicknamedCoco">
<meta property="article:tag" content="多线程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.wkyes.com/blog/thread/thread1/1.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button sidebar-nav-active" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel sidebar-panel-active" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="NicknamedCoco"><img width="96" loading="lazy" src="https://cdn.wkyes.com/blog/bg/keyi.jpg" alt="NicknamedCoco"></a><div class="site-author-name"><a href="/about/">NicknamedCoco</a></div><a class="site-name" href="/about/site.html">CocoBlog</a><sub class="site-subtitle">OneForAll</sub><div class="site-description">寻找自己的价值，才是生命的意义</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="我的主页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">138</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">84</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=506579631&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><span class="icon iconify" data-icon="ri:qq-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/NicknamedCoco" title="GitHub" target="_blank" style="color:#1da1f2"><span class="icon iconify" data-icon="ri:github-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/NicknamedCoco/" title="知乎" target="_blank" style="color:#0084FF"><span class="icon iconify" data-icon="ri:zhihu-line"></span></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/NicknamedCoco" title="Twitter" target="_blank" style="color:#1da1f2"><span class="icon iconify" data-icon="ri:twitter-line"></span></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content">此文章未包含目录</div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="https://wkyes.com/2022/01/14/%E8%81%8A%E8%81%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E4%B8%80/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="NicknamedCoco"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="CocoBlog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">聊聊多线程(一)</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2022-01-14 20:01:51" itemprop="dateCreated datePublished" datetime="2022-01-14T20:01:51+08:00">2022-01-14</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2023-06-16 13:40:33" itemprop="dateModified" datetime="2023-06-16T13:40:33+08:00">2023-06-16</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">9.2k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">34m</span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="评论数"><span class="icon iconify" data-icon="ri:chat-3-line"></span> <span class="waline-comment-count" id="/2022/01/14/%E8%81%8A%E8%81%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E4%B8%80/"></span></span></a><div class="post-classify"><span class="post-tag"><a class="tag-item" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">多线程</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><blockquote>
<p>近况</p>
</blockquote>
<p>实习结束了就回到家里，准备毕设和学习多线程了，我还是自制力太差，学习效果不太好，自制力差的原因<br>在于没有认清自己目前所处的阶段，所以才无所事事，在沉沦很多天之后，期间断断续续学习，坦白说<br>没有很好的收获，人啊，一旦没有了目标，心就空了，就容易迷茫，人还是应该有所追求，有目标才有动力。</p>
<p>我一直认为，学习如果没有输出，是很难继续下去的，这就是为什么我写博客的原因，哪怕没人看<br>最近一段时间开始学习多线程，原本想搞定完毕设再学习的，但是毕设学习若依项目，继续不下去，<br>而且需要另写一套前端，CSS极差，又没有经验写，虽然学习过vue，但是我给鸽了，唉，<br>我怕再不学习多线程，等家人都回来过年了，吵吵闹闹的又没定力学习去了，怕是又跑去打麻将了~<br>所以趁家人没回来，赶紧把多线程学习了，这个多线程，是我众多心病之一，所以要解决掉它<br>现在写第一篇多线程博客，随便聊聊</p>
<p>本篇博客内容如下：</p>
<ul>
<li><a href="#a">Java线程的6种状态</a></li>
<li><a href="#b">创建线程的3种方式</a></li>
<li><a href="#c">Thread的常用方法</a></li>
<li><a href="#d">线程安全问题</a></li>
<li><a href="#e">变量的线程安全分析</a></li>
<li><a href="#f">常见的线程安全类</a></li>
<li><a href="#g">对象头与monitor</a></li>
<li><a href="#h">synchronized原理</a></li>
<li><a href="#i">synchronized原理进阶</a></li>
<li><a href="#j">文章及资料</a></li>
</ul>
<blockquote>
<p><span id="a">Java线程的6种状态</span></p>
</blockquote>
<p>我们有时候很难分清楚线程的状态到底有几种，有人说5种，有人说6种，我们在操作系统上看到过<br>进程的5种状态，你可能有疑问，进程？是的，操作系统上说的是进程的5种状态，一般指的是进程只有1个线程。<br>所以，操作系统书上说进程的5种状态，我们可以简单理解为线程的5种状态。<br>这5种状态是：新建，就绪，运行，阻塞/等待，死亡</p>
<p>这5种状态是对于操作系统而言的，而对于JVM而言，却是有6种线程状态，Java线程的6种状态在Thread类<br>中的State枚举类中，它们分别是：New，Runnable，Blocked，Waiting，Timed_Waiting，Terminated</p>
<p>注意：这6种状态与操作系统状态并不是一一对应的，例如Java中的Runnable状态相当于操作系统中的<br>就绪，运行，一部分阻塞状态(IO阻塞)，而Blocked，Waiting，Timed_Waiting都属于操作系统中阻塞状态的一部分。<br><img src="https://cdn.wkyes.com/blog/thread/thread1/1.png"/ loading="lazy"></p>
<p>具体聊聊Java的线程状态</p>
<ul>
<li>新建和死亡状态与操作系统中一致，就没什么好讲的</li>
<li>Runnable状态这是对jvm而言，jvm才不需要管操作系统如何调度线程，不管这个线程在操作系统中<br>是就绪状态，还是运行状态，还是在等待IO操作完成，对于jvm来说都是Runnable状态，</li>
<li>Blocked状态则是多线程环境中，使用synchronized关键字，当线程被动阻塞后，<br>这个线程的状态就是Blocked，这个线程会被放进monitor对象的entry list中，当然这是后话了<br>简单而言，当线程进入同步方法时，没有拿到锁时，该线程处于blocked状态</li>
<li>Waiting状态<br>当线程拿到锁进入同步代码块后，主动调用wait方法，主动阻塞后，该线程释放锁，进入monitor对象<br>中的wait set中，等到其他线程调用notify方法唤醒，此时该线程处于Waiting状态，当该线程被唤醒后，<br>重新获取锁，获取锁失败，进入entry set中等待竞争锁，waiting状态转变成blocked状态，<br>获取锁成功，则waiting状态转变成runnable状态，并从之前调用wait方法处开始执行。</li>
<li>Timed_Waiting<br>当线程在执行代码时调用sleep等方法，并不一定要在同步代码块中调用，只要调用sleep等方法<br>则该线程进入monitor对象的wait set中，此时的线程状态是Time_Waiting，相比于Waiting状态<br>Timed_Waiting状态是有限时间内等待，而处于Waiting状态的线程则是需要其他线程唤醒的，<br>Timed_Waiting状态的线程则不需要，另外，sleep方法并不会释放锁，时间一到，线程继续执行<br>原来的代码，而不需要竞争，另外不只是sleep方法可以使线程处于Timed_Waiting状态，<br>像wait(时间)，join(时间)，这些方法都可以，都是使线程有限时间内等待，当然，这种方式就释放<br>锁了。</li>
</ul>
<p>看完线程状态，你可能仍然觉得，写的什么鬼，乱七八糟的，没关系，我找到了一个大佬的文章<br>看完感觉神清气爽，仿佛打通任督二脉~</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://xiaogd.net/md/%E5%85%B3%E4%BA%8Ejava%E7%9A%84%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81">关于 Java 的线程状态</a></li>
<li><a target="_blank" rel="noopener" href="https://xiaogd.net/md/java-%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E4%B9%8B-runnable">Java 线程状态之 RUNNABLE</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/goldenshaw/blog/706663">Java 线程状态之 BLOCKED</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/goldenshaw/blog/802620">Java 线程状态之 WAITING</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/goldenshaw/blog/806018">Java 线程状态之 TIMED_WAITING</a></li>
</ul>
<blockquote>
<p><span id="b">创建线程的3种方式</span></p>
</blockquote>
<ul>
<li><p>通过Thread子类，或者匿名类创建线程</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//通过Thread创建线程</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自定义线程正在执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main线程执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>重写run方法后，当jvm调用run方法时，就走重写后的run方法。</p>
</li>
<li><p>通过Runnable接口创建线程</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//通过runnable接口配合Thread创建线程，下面是不断的简化</span>
    <span class="token comment">//方式1</span>
    <span class="token class-name">Runnable</span> runnable  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"t1线程正在执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">,</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//方式2</span>
    <span class="token class-name">Runnable</span> runnable1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"t2线程正在执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable1<span class="token punctuation">,</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//方式3</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"t3线程正在执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"t3"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main线程执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>通过Callable接口创建线程<br>我们从Runnable接口可以看到，实际上是将同步代码抽离成接口，但是这个run方法并不能抛出异常<br>也没有返回值，而Callable接口有返回值并且可以抛出异常。</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//通过FutureTask配合Thread创建线程</span>
<span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"t4线程正在执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span><span class="token string">"t4"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Integer</span> result <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"main线程执行，拿到t4线程数据："</span><span class="token operator">+</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//这种方式能使得main线程拿到其他线程的返回值</span></code></pre>



</li>
</ul>
<blockquote>
<p><span id="c">Thread的常用方法</span></p>
</blockquote>
<p>Thread有很多方法，我这里就不一一介绍了，下面是一些常用的方法的含义<br><img src="https://cdn.wkyes.com/blog/thread/thread1/2.png"/ loading="lazy"></p>
<p>我这里就简单聊聊<strong>interrupt方法</strong><br>当我们想停止一个线程时，我们可能会发现Thread类中有stop方法，但是这个stop方法却被废弃了<br>因为stop方法太暴力了，还没等线程处理完自己的事就直接关掉，所以后来使用了Interrupt方法来代替stop方法<br>当在主线程代码中，其他线程调用interrupt方法后，相当于主线程通知其他线程快点结束吧，并不会直接杀掉该线程<br>其他线程停不停止完全取决于自己的处理，interrupt方法仅仅给该线程设置一个打断标记，线程打断标记默认是false<br>下面是来自interrupt源码注释的三句话：</p>
<pre class="language-none"><code class="language-none">调用正常运行线程的isInterrupted方法返回false，即打断标记默认为false
调用正常运行中线程的interrupt方法会将打断标记置为true
interrupt一个被sleep，wait，join锁住的方法，会将打断标记置为true，然后清除打断标记，
然后throw interrupted exception，这里的清除打断标记，我想是恢复打断标记为false</code></pre>

<p>由上可知，打断一个线程就是仅仅通知该线程应该尽快结束运行，那被打断线程应该如何停止当前线程呢？<br>等下讲讲多线程设计模式中的二阶段终止模式。</p>
<p>我们还需要了解的方法是，<strong>isInterrupted方法和interrupted方法</strong><br>这两个方法都是用来判断当前线程是否被打断了，但有区别的是，isInterrupted方法判断后，不会修改线程打断标记<br>而interrupted方法判断后，会修改当前线程的打断标记，false改为true，true改为false。</p>
<p>除了使用interrupt方法可以打断线程，LockSupport的park方法也可以打断线程，下面是一个例子：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"进入线程run方法，此时线程打断标记："</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//当线程打断标记为false时，则线程在此处暂停运行,如果当前线程打断标记为true，则不会暂停，直接向下运行</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程被打断后，继续运行,此时线程打断标记："</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"通过调用intercepted方法，查看线程打断标记"</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"再来看此时的线程打断标记："</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>结果输出为：</p>
<pre class="language-none"><code class="language-none">进入线程run方法，此时线程打断标记：false
线程被打断后，继续运行,此时线程打断标记：true
通过调用intercepted方法，查看线程打断标记true
再来看此时的线程打断标记：false</code></pre>

<p>那么，既然interrupt方法只是通知被打断线程尽快结束线程，那么我们应该如何停止一个线程呢？<br><strong>二阶段终止模式</strong><br>来看看该模式下的代码</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test3</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
            多线程的设计模式之二阶段终止模式
            该设计模式用来在一个线程T1中优雅的终止线程T2

            错误思路
                1，使用线程对象的stop方法停止线程
                    stop方法会真正杀死线程，如果这时线程锁住了共享资源，那么当它被杀死后就再也没有机会释放锁
                    其他线程将永远无法获取锁
                2，使用System.exit(int)方法停止线程
                    目的仅是停止一个线程，但这种做法会让整个程序都停止

         */</span>

        <span class="token class-name">TwoPhaseTermination</span> twoPhaseTermination <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TwoPhaseTermination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        twoPhaseTermination<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        twoPhaseTermination<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">TwoPhaseTermination</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"正在开启线程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程正在停止，处理后事"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"线程休眠之前"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行业务逻辑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"异常处理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//停止线程</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>由上我们看到，我们在catch块异常处理中，再次打断了当前线程，这是因为，如果线程休眠时当前线程中断标志<br>为true，则会抛出打断异常，并会清除打断标志，即将打断标志true改为false，这样的话，再一次循环就出不去了<br>所以在异常处理中，再一次打断线程，将因异常被改为false的中断标志，重新改为true，从而停止while循环，停止线程运行。</p>
<p>有一点需要注意的是：只要线程的中断标志为true时调用了sleep等方法，都会抛出中断异常，并不一定要<br>线程在睡眠的时候中断，才会抛出异常，当然，在线程睡眠之后，哪怕仍然在try catch块中打断线程，都不会抛出<br>中断异常。</p>
<p>总之：线程停不停止运行，不在于自身被不被打断，而在于自己想不想停止！线程停止运行最好使用二阶段终止模式。</p>
<blockquote>
<p><span id="d">线程安全问题</span></p>
</blockquote>
<p>什么是线程安全？在多线程环境下，因为线程上下文切换导致其执行顺序发生改变，从而影响最终结果的代码存在线程安全问题。<br>下面是一段存在线程安全的代码</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//成员变量，被所有线程共享</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">5000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            count<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"count的值是&#123;&#125;"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>如果了解过JMM，java内存模型的都知道，count++，count–的操作在底层都不是原子性的操作，它分为多个指令<br>下面是JMM，内存模型<br><img src="https://cdn.wkyes.com/blog/thread/thread1/3.png"/ loading="lazy"></p>
<p>可以看到，每个线程都有自己的工作内存，一个线程如果对一个数相加，需要先从主内存(共享内存)中拿到值<br>拷贝到工作内存中，再对工作内存中数据+1，再将相加后的结果写回主内存中。正常的执行顺序如下：<br><img src="https://cdn.wkyes.com/blog/thread/thread1/4.png" style="zoom:80%;" / loading="lazy"></p>
<p>但是如果发生线程上下文切换的时候，就是下面这种执行顺序<br>出现负数的情况</p>
<img src="https://cdn.wkyes.com/blog/thread/thread1/5.png" style="zoom:80%;" / loading="lazy">
出现正数的情况：
<img src="https://cdn.wkyes.com/blog/thread/thread1/6.png" style="zoom:80%;" / loading="lazy">

<p>我们知道，线程上下文切换是操作系统调度的，JVM并不能控制什么时候切换，什么时候不切换，那如果解决呢？<br>答案当然是使用synchronized关键字，对那些多线程修改共享变量的代码进行加锁，也就是对临界区进行加锁<br>临界区是操作系统的名词，指的是：一段代码内如果存在对共享资源的多线程读写操作，那么称这段代码为临界区<br>如果任由多个线程在临界区执行对共享变量读写操作，则一定会发生线程安全问题，所以我们要控制在多线程<br>并发修改共享变量的时候，只能有一个线程进入临界区修改代码，这也叫加锁，锁的是临界区的代码<br>加锁的方式有很多种，最常用的就是使用synchronized关键字，我们知道，synchronized关键字可以使用在<br>静态方法上，锁的对象是该类的Class对象，可以使用在实例方法上，锁的对象是该类的实例，<br>可以使用在方法块上，锁的就是提供的参数对象</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//临界区</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//临界区</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>对象<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">//这里的对象可以是任意对象</span>
        <span class="token comment">//临界区</span>
    <span class="token punctuation">&#125;</span>    
<span class="token punctuation">&#125;</span></code></pre>

<p>上面案例中的代码修改如下，即可解决线程安全问题：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> room <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
     <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
             <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>room<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
             counter<span class="token operator">++</span><span class="token punctuation">;</span>
        	<span class="token punctuation">&#125;</span>
 		<span class="token punctuation">&#125;</span>
 	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
             <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>room<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
             counter<span class="token operator">--</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"&#123;&#125;"</span><span class="token punctuation">,</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>synchronized实际上利用对象保证了临界区代码的原子性，临界区内的代码在外界看来是不可分割的，不会被线程切换所打断<br><img src="https://cdn.wkyes.com/blog/thread/thread1/7.png"  / loading="lazy"></p>
<blockquote>
<p><span id="e">变量的线程安全分析</span></p>
</blockquote>
<p>之所以存在线程安全问题，就是因为多个线程并发修改共享变量的值，如果变量不是共享的，<br>或者多个线程只是读取并未修改共享变量，都不会产生线程安全问题。那么关键在于变量是否是共享变量<br>下面是一段对变量的安全分析</p>
<ul>
<li><p>成员变量(实例变量+静态变量)和静态变量的线程安全分析</p>
<ul>
<li><p>如果没有变量没有在线程间共享，那么变量是安全的<br><strong>实例变量没有共享案例</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyThread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyThread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            count<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//输出结果</span>
t1<span class="token operator">:</span><span class="token number">4</span>
t2<span class="token operator">:</span><span class="token number">4</span>
t2<span class="token operator">:</span><span class="token number">3</span>
t2<span class="token operator">:</span><span class="token number">2</span>
t2<span class="token operator">:</span><span class="token number">1</span>
t2<span class="token operator">:</span><span class="token number">0</span>
t1<span class="token operator">:</span><span class="token number">3</span>
t1<span class="token operator">:</span><span class="token number">2</span>
t1<span class="token operator">:</span><span class="token number">1</span>
t1<span class="token operator">:</span><span class="token number">0</span></code></pre>
</li>
<li><p>如果变量在线程间共享<br>1)如果只有读操作，则线程安全<br>2)如果有读写操作，则这段代码是临界区，需要考虑线程安全</p>
<p><strong>实例变量共享案例</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">/*
    实例变量是共享变量有多种方式，例如上面的案例，如果把private int count = 5;加上static静态变量
    因为静态变量是所有类实例共享的，所以count变量是共享变量
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">MyRunnable</span> myRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyRunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>myRunnable<span class="token punctuation">,</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>myRunnable<span class="token punctuation">,</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">MyRunnable</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            count<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//输出结果</span>
t2<span class="token operator">:</span><span class="token number">3</span>
t1<span class="token operator">:</span><span class="token number">3</span>
t2<span class="token operator">:</span><span class="token number">1</span>
t1<span class="token operator">:</span><span class="token number">1</span>
t1<span class="token operator">:</span><span class="token number">0</span></code></pre>
</li>
</ul>
</li>
<li><p>局部变量线程安全分析</p>
<ul>
<li><p>局部变量【局部变量被初始化为基本数据类型】是安全的</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
     i<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
</li>
<li><p>局部变量引用的对象未必是安全的<br>1)如果局部变量引用的对象没有引用线程共享的对象，那么是线程安全的<br>2)如果局部变量引用的对象引用了一个线程共享的对象，那么要考虑线程安全的</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test15</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">UnsafeTest</span> unsafeTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnsafeTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
                unsafeTest<span class="token punctuation">.</span><span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"线程"</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name">UnsafeTest</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> arrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        arrayList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>上述案例中，method2和method3引用的变量是多个线程共享的成员变量，所以上述代码是线程不安全的<br>代码的内存示意图如下：</p>
<img src="https://cdn.wkyes.com/blog/thread/thread1/8.png"  / loading="lazy">

<p>我们只需要将共享的成员变量，修改成局部变量即可，代码如下：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">class</span> safeTest<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> arrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">method2</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">method3</span><span class="token punctuation">(</span>arrayList<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span> arrayList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        arrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">method3</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span> arrayList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        arrayList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>修改后的内存示意图如下：</p>
<img src="https://cdn.wkyes.com/blog/thread/thread1/9.png" style="zoom:80%;" / loading="lazy">

</li>
</ul>
</li>
</ul>
<p>看一个类是否是线程安全，先关注变量是否共享，再关注共享变量是否被修改，<br>下面是一些文章，关于线程间通过共享变量通信，和变量的线程安全性分析</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37695902/article/details/119032369">成员变量与线程安全</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37695902/article/details/119032737">任何一个类只要没有成员变量，就是线程安全的</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tonglin0325/p/6260485.html">Java多线程——线程范围内共享变量和ThreadLocal</a></li>
</ul>
<p>以上便是变量的线程安全分析</p>
<blockquote>
<p><span id="f">常见的线程安全类</span></p>
</blockquote>
<p>常见的线程安全类如下：</p>
<ul>
<li>String</li>
<li>Integer</li>
<li>StringBuffer</li>
<li>Random</li>
<li>Vector，底层list</li>
<li>Hashtable，底层map</li>
<li>JUC包下的类</li>
</ul>
<p>这里所说它们是线程安全指的是：多个线程调用它们同一个实例的某个方法时，是线程安全的<br>例如：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Hashtable</span> table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
 	table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
 	table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>但是，并不代表这些类方法的组合是线程安全的，例如下面代码就不是线程安全的：</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Hashtable</span> table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 线程1，线程2</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> table<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>线程调用示意图如下：<br><img src="https://cdn.wkyes.com/blog/thread/thread1/10.png"  / loading="lazy"></p>
<blockquote>
<p><span id="g">对象头与monitor</span></p>
</blockquote>
<p>之前说过，要解决线程安全问题，最常用的是使用synchronized关键字进行加锁，那么在学习synchronized原理之前<br>我们先来了解一下什么是对象头和monitor</p>
<p><strong>对象头</strong><br>一个Java对象包括三个部分，对象头，实例数据，对齐补充，其中对象头又包括Mark Word，Klass Word<br>如图所示：<br><img src="https://cdn.wkyes.com/blog/thread/thread1/11.png"  / loading="lazy"></p>
<p>再看具体对象头具体结构，以 32 位虚拟机为例</p>
<ul>
<li>普通对象的对象头结构如下，其中的Klass Word为指针，指向对应的Class对象<img src="https://cdn.wkyes.com/blog/thread/thread1/12.png"  / loading="lazy"></li>
<li>数组对象的对象头结构如下<img src="https://cdn.wkyes.com/blog/thread/thread1/13.png"  / loading="lazy">

</li>
</ul>
<p>对象头中Mark Word有以下几种状态：<br><img src="https://cdn.wkyes.com/blog/thread/thread1/14.png"  / loading="lazy"><br>其中，Normal指的是一个对象创建出来，默认无锁的，即Normal状态<br>如果经过JVM配置的话，我们可以使得对象一创建出来是拥有偏向锁的，即Biased，与Normal区别在于Mark Word的倒数第三位是1<br>拥有偏向锁的对象，其Mark Word中保存的是线程的ID，这个ID是操作系统级别，并不是JVM<br>Lightweight Locked则指的是轻量级锁，它的Mark Work中保存的是栈帧中的锁记录指针，<br>锁记录是栈帧中一个对象，这里记录的是锁记录的地址，具体最后一节再说。<br>Heavyweight Locked表示的是重量级锁，如果多个线程竞争对临界区的共享变量进行操作，我们可以通过<br>synchronized关键字为该对象进行加锁，加锁就是改变这个对象对象头的Mark Word，换成一个monitor地址<br>monitor是操作系统创建的一个内存空间，具体等下介绍。<br>Marked for GC，当GC线程检测该对象没有被引用后，就将堆中该对象的内存回收。</p>
<p><strong>Monitor</strong><br>Monitor，也被叫做管程或监视器，其实是一种同步工具，也可以说是一种同步机制，它通常被描述为一个对象<br>我们可以简单理解为操作系统分配的一个内存空间。不同的编译器对monitor有不同的实现。<br>在HotSpot虚拟机中，Monitor是基于C++的<strong>ObjectMonitor类</strong>实现的，其主要成员包括：</p>
<pre class="language-none"><code class="language-none">_owner：指向持有ObjectMonitor对象的线程
_WaitSet：存放处于wait状态的线程队列，即调用wait()方法的线程
_EntryList：存放处于等待锁block状态的线程队列
_count：约为_WaitSet 和 _EntryList 的节点数之和
_cxq: 多个线程争抢锁，会先存入这个单向链表
_recursions: 记录重入次数</code></pre>

<p>每个java对象都可以关联一个Monitor，如果使用<code>synchronized</code>给对象上锁（重量级），<br>该对象头的Mark Word中就被设置为指向Monitor对象的指针<br><img src="https://cdn.wkyes.com/blog/thread/thread1/15.png"  / loading="lazy"></p>
<p>上图具体含义如下：</p>
<ul>
<li>刚开始时Monitor中的Owner为null</li>
<li>当Thread-2 执行synchronized(obj){}代码时就会将Monitor的所有者Owner 设置为 Thread-2，上锁成功<br>Monitor中同一时刻只能有一个Owner</li>
<li>当Thread-2 占据锁时，如果线程Thread-3，Thread-4也来执行synchronized(obj){}代码，<br>就会进入EntryList中变成BLOCKED状态</li>
<li>Thread-2 执行完同步代码块的内容，然后唤醒 EntryList 中等待的线程来竞争锁，竞争时是非公平的</li>
<li>图中 WaitSet 中的 Thread-0，Thread-1 是之前获得过锁，但条件不满足进入 WAITING 状态的线程，<br>这里的条件不满足，指的是线程主动阻塞调用wait方法，调用wait方法后，当前线程释放锁，<br>并进入wait set等待其他线程唤醒。</li>
</ul>
<p>注意：synchronized 必须是进入同一个对象的monitor才有上述的效果，不加 synchronized 的对象不会关联监视器(monitor)。</p>
<blockquote>
<p><span id="h">synchronized原理</span></p>
</blockquote>
<p>synchronized关键字就是用来给同步代码块加锁的，加锁指的是线程去修改锁对象的对象头的mark word为其他指针<br>如果修改成功，则表示该线程成功上锁，或者该线程成功拿到锁，锁分为下面几种：</p>
<ul>
<li>如果是重量级锁，则mark word中就是指向一个monitor地址，或者说指向一个monitor对象<br>相当于让这个对象关联了一个monitor对象</li>
<li>如果是轻量级锁，则mark word中就是指向当前线程所在栈的栈帧的锁记录，这个锁记录可以理解为<br>栈帧中的一个对象(Lock Record)，说白了，mark word保存的也是指向一个对象的地址</li>
<li>如果是偏向锁，则mark word中就是指向当前线程的ID，把当前整个线程抽象成一个内存空间，<br>类似的monitor，锁记录都是一块内存空间。</li>
</ul>
<p>在锁的级别上来看，偏向锁是对轻量级锁的优化，轻量级锁是对重量级锁的优化，都是通过synchronized关键字来实现<br>jvm默认创建的对象是无锁状态，随着线程竞争越来越激烈，锁会从偏向锁升级到轻量级锁，最后是重量级锁。</p>
<p><strong>我一直不知道怎么描述锁到底是什么东西，synchronized需要的对象是锁吗？monitor对象是锁吗？</strong><br><strong>后来我终于感觉到，锁其实是一种机制，一种保证多线程环境下只有一个线程进入临界区的机制。</strong><br><strong>锁记录，monitor，synchronized需要的对象等等，都是锁机制的一部分，偏向锁，轻量级锁，重量级锁</strong><br><strong>也都是一种机制，锁不是某个地址空间，某个对象。</strong></p>
<p>有时候你可能看到说加锁指的是对synchronized指定的对象加锁，这个对象被称为锁对象，<br>我觉得加锁指的是对临界区加锁，当然这个对象也可以说是锁对象，只是这些乱七八糟的含义很影响学习<br>比如成员变量，全局变量，实例变量，静态变量，或者javaweb中描述实体类的pojo，bean，domain。</p>
<blockquote>
<p><span id="i">synchronized原理进阶</span></p>
</blockquote>
<p>这小节细讲一下synchronized中各个锁机制</p>
<ul>
<li><p><strong>轻量级锁</strong><br>锁是一种机制，当锁对象(synchronized指定的对象)的mark word指向线程的栈帧中锁记录时，<br>我们称这个线程获得了轻量锁，锁记录简单理解为使用synchronized就在栈帧中创建一个锁记录对象吧</p>
<p>轻量级锁的使用场景是：如果一个对象虽然有多个线程要对它进行加锁，但是加锁的时间是错开的<br>（也就是没有人可以竞争的），那么可以使用轻量级锁来进行优化。轻量级锁对使用者是透明的，<br>即语法仍然是<code>synchronized</code>，假设有两个方法同步块，利用同一个对象加锁</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token comment">// 同步块 A</span>
         <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         <span class="token comment">// 同步块 B</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>线程获取轻量锁流程如下：</p>
<ul>
<li>每次线程运行到synchronized代码块时，都会创建锁记录（Lock Record）对象，<br>锁记录内部可以储存对象的Mark Word和对象引用reference（这个对象就是synchronized指定的对象）<img src="https://cdn.wkyes.com/blog/thread/thread1/16.png"  / loading="lazy"></li>
<li>让锁记录中的Object reference指向对象，并且尝试用cas(compare and sweep)替换<br>Object对象的Mark Word ，将Mark Word 的值存入锁记录中<img src="https://cdn.wkyes.com/blog/thread/thread1/17.png"  / loading="lazy"></li>
<li>如果cas替换成功，那么对象的对象头储存的就是锁记录的地址和状态01，如下所示<img src="https://cdn.wkyes.com/blog/thread/thread1/18.png"  / loading="lazy"></li>
<li>如果cas失败，有两种情况<br>1)如果是其它线程已经持有了该Object的轻量级锁，那么表示有竞争，将进入锁膨胀阶段<br>2)如果是自己的线程已经执行了synchronized进行加锁，那么那么再添加一条 Lock Record 作为重入的计数<img src="https://cdn.wkyes.com/blog/thread/thread1/19.png"  / loading="lazy"></li>
<li>当线程退出synchronized代码块的时候，如果获取的是取值为 null 的锁记录 ，表示有重入，则直接释放掉，删除锁记录<img src="https://cdn.wkyes.com/blog/thread/thread1/20.png"  / loading="lazy"></li>
<li>当线程退出synchronized代码块的时候，如果获取的锁记录取值不为 null，那么使用cas将Mark Word的值恢复给对象<br>1)成功则解锁成功<br>2)失败，则说明轻量级锁进行了锁膨胀或已经升级为重量级锁，进入重量级锁解锁流程</li>
</ul>
</li>
<li><p><strong>锁膨胀</strong><br>如果线程在cas交换Object中mark word时失败，说明之前已经有线程交换过Object信息了，<br>如果是自己，则进入锁重入阶段，即当前线程创建一个新的锁记录对象，并将锁记录的地址设置为null</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> obj<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token comment">// 同步块</span>
      <span class="token class-name">A</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token keyword">synchronized</span><span class="token punctuation">(</span> obj <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token comment">// 同步块 B</span>
      <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>上面代码中，如果一个线程进入method1的同步代码块时，则栈帧中就创建了一个锁记录对象，<br>当在锁记录中又调用其他同步方法时，则会创建一个值为null的锁记录，这就是锁重入。</p>
<p>如果不是自己，是其他线程已经为这个对象加上了轻量级锁，那么就要进入锁膨胀阶段，即升级为重量级锁</p>
<ul>
<li>当 Thread-1 进行轻量级加锁时，Thread-0 已经对该对象加了轻量级锁<img src="https://cdn.wkyes.com/blog/thread/thread1/21.png"  / loading="lazy"></li>
<li>这时 Thread-1 加轻量级锁失败，进入锁膨胀流程<br>即为对象申请Monitor锁，让Object指向重量级锁地址，然后自己进入Monitor 的EntryList变成BLOCKED状态<img src="https://cdn.wkyes.com/blog/thread/thread1/22.png"  / loading="lazy"></li>
<li>当Thread-0 推出synchronized同步块时，使用cas将Mark Word的值恢复给对象头，失败，那么会进入重量级锁的解锁过程，即按照Monitor的地址找到Monitor对象，将Owner设置为null，唤醒EntryList 中的Thread-1线程</li>
</ul>
</li>
<li><p><strong>锁自旋</strong></p>
<p>重量级锁竞争锁资源的时候，还可以通过自旋来进行优化，<br>场景发生在：当锁资源被占用的情况下，Monitor对象中的Entry List线程不用马上进入堵塞队列，<br>而是进入自旋状态，简单可以理解为在做循环试探锁资源是否被释放了，目的是达到锁资源一释放就可以<br>立马被下一个线程使用，不要再去进行唤醒操作。<br>但是要注意的是：</p>
<ul>
<li>自旋会占用CPU的资源，如果是单核CPU就会存在很大的浪费，所以自旋使用与多核的CPU.</li>
<li>Java 7之后就不能手动控制是否开启自旋功能了，而是由JVM自动执行，并且是自适应的，<br>例如如果一次自旋成功，就会被认为自旋成功的可能性大，就会多自旋几次，反之，少自旋或者不自旋，设计的比较智能。</li>
</ul>
</li>
<li><p><strong>偏向锁</strong><br>偏向锁是对轻量级锁的优化，在轻量级锁中，我们可以发现，如果同一个线程对同一个对象进行重入锁时，<br>也需要执行CAS操作，这个操作非常耗时，那么java6开始引入了偏向锁，只有第一次使用CAS时将对象的<br>Mark Word头设置为线程ID，之后这个线程再进行重入锁时，发现线程ID是自己的，那么就不用再进行CAS了。</p>
<img src="https://cdn.wkyes.com/blog/thread/thread1/23.png"  / loading="lazy">

<p>如果发现线程ID不是自己的时候，就会尝试CAS替换操作：<br>如果操作成功了， 此时该线程就获得了锁对象。( <code>此时是交替访问临界区, 撤销偏向锁, 升级为轻量级锁</code>)<br>如果操作失败了， 此时说明发生了锁竞争。( <code>此时是多线程访问临界区, 撤销偏向锁, 升级为重量级锁</code>)</p>
<ul>
<li><p>偏向锁的状态<br>1）一个java对象在被创建出来的时候，这个对象的对象头中mark word默认是偏向锁状态，<br>其mark word末尾三位是101，此时其他位(thread位，epoch位，age位)都是0，这些值都是在加锁的时候才会被设置</p>
<p>2）可当你测试的时候，你会发现你打印的对象的mark word信息末尾三位竟然是001，也就是无锁状态<br>这是因为对象偏向锁状态默认是有延迟的，不会在程序启动的时候立刻生效，如果想避免延迟，<br>可以添加虚拟机参数来禁用延迟：<code>-XX:BiasedLockingStartupDelay=0</code>来禁用延迟</p>
<p>3）处于偏向锁的对象解锁后，线程 id 仍存储于对象头中，这就体现了偏向的概念了<br>等待下次同一个线程再次加锁就会发现，这个线程id与自己一致，表明需要进行锁重入了，而不需要进行CAS替换</p>
</li>
<li><p>偏向锁被撤销的三种情况<br>1）synchronized指定的对象，即锁对象调用了hashcode方法后，该对象就从偏向锁状态转为无锁状态</p>
<p>2）当其他线程进行cas交换失败时，此时偏向锁被撤销，升级为轻量级锁，偏向锁适合一个线程执行同步代码块<br>轻量级锁适合多个线程执行不同的代码块，或者交替获取锁，没有存在竞争情况<br>重量级锁适合多个线程竞争执行同一个代码块，存在相互竞争的情况</p>
<p>3）当锁对象调用wait,notify方法后，偏向锁会被撤销，这时偏向锁会转变为重量级锁，因为这些方法是重量级锁才有。</p>
</li>
<li><p>批量重偏向<br>当只有一个线程在执行同步代码块时，这是锁对象状态是偏向锁状态，但如果此时另一个线程获取锁<br>执行其他同步代码块，没有产生竞争时，这时锁对象状态从偏向锁状态被撤销，升级为轻量级锁状态，<br>如果线程中上述对象撤销偏向锁的次数超过20次，则对象的mark ward的线程ID会偏向另一个线程。</p>
</li>
<li><p>批量撤销<br>如果线程中上述对象撤销偏向锁的次数超过40次，则之后创建的所有对象都是无锁状态。</p>
</li>
<li><p>锁消除<br>如果jvm中的即时编译器发现你同步代码块中，根本没有对共享变量的修改，或者根本没有线程安全问题<br>那么你加的synchronized并不会生效，编译后的字节码中不存在monitorenter和monitorexit原语<br>相当于没写synchronized，这就是锁消除。</p>
</li>
</ul>
</li>
</ul>
<p><strong>梳理下整个流程</strong><br>假设我们关闭了偏向锁的延迟，那么创建的锁对象的mark word状态是偏向锁状态<br>此时一个线程准备进入同步代码块，我们叫它t1吧，t1线程碰到synchronized关键字，首先检查锁对象状态<br>很显然是偏向锁状态，但此时的mark word只有后三位是101，而前面位数都还是0，t1线程随即进行CAS操作<br>将t1线程的线程id保存到mark word中，当然，此时没其他线程跟它争抢，CAS操作成功代表t1线程拥有了锁<br>紧接着t1线程执行同步代码块中代码。</p>
<p>当t1线程在同步代码块中又调用了其他同步方法，则t1线程会检查锁对象中的markword保存的内容，<br>很显然，markword中保存的正是t1线程id，这时t1不需要进行CAS操作就拥有锁，这是锁重入</p>
<p>当t1线程执行完同步代码块后，锁对象中markword仍然保留着t1线程的线程id，等t1线程走后<br>t2线程执行同步代码块，t2线程会撤销锁对象的偏向锁，升级为轻量级锁，t2会在栈帧中创建锁记录对象<br>并进行CAS操作，交换锁对象中的mark word，使mark word保存锁记录的地址，当然锁记录中还会保存<br>锁对象的地址，此时锁对象的mark word中后两位是00，代表此时已经是轻量级锁的状态</p>
<p>当t2线程还未结束同步代码块时，又有一个线程t3准备进入和t2同一处代码块中，首先t3进行CAS交换锁对象<br>的mark word信息，发现CAS操作失败了，这时，t3线程会申请一个monitor对象，并将锁对象中mark word<br>锁记录的地址改成monitor对象的地址，然后t3修改monitor中owner指向，使之指向t2线程，并自己保存在<br>monitor对象的entry set中。</p>
<p>当t2线程结束同步代码块时，t2进行CAS操作，交换锁对象的mark word信息，发现失败了，于是通过锁对象<br>中保存的monitor的地址，找到monitor对象，将monitor中owner引用置为null，并唤醒entry set中的t3线程<br>最后t2线程退出同步代码块中</p>
<p>以上过程是非常不清晰的，部分重要操作有遗漏，仅仅当做大概的流程，等以后学习更加深入再更新<br>下面是一张锁升级步骤图，可能也有些不太正确，例如自旋并不会发生在获取轻量级锁时，而是用来获取重量级锁<br><img src="https://cdn.wkyes.com/blog/thread/thread1/24.png"  / loading="lazy"></p>
<blockquote>
<p><span id="j">文章及资料</span></p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.nowcoder.net/n/3943f69fa12f4ec8b32249948ff43501?from=nowcoder_improve">Java Monitor对象与Synchronized原理</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37989980/article/details/111460733">学习《Java并发编程》目录索引 (持续更新中)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yescode/p/14474104.html">轻量级锁会自旋？好像并不是这样的</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wade-luffy/p/5969418.html">偏向锁，轻量级锁，自旋锁，重量级锁的详细介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/aspirant/p/11470858.html">深入分析Synchronized原理(阿里面试题)</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1465413">深入理解synchronized底层原理，一篇文章就够了！</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/141554048">轻量级锁加解锁过程详解</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1520488">通俗易懂讲解偏向锁、轻量级锁和重量级锁</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NicknamedCoco/cdn/tree/master/blog/thread">github上的资料</a></li>
</ul>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><span class="icon iconify" data-icon="ri:hand-coin-line"></span></span><div id="reward-comment">一分也是爱~~</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.wkyes.com/blog/pay/alipay.jpg"><img loading="lazy" src="https://cdn.wkyes.com/blog/pay/alipay.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.wkyes.com/blog/pay/wechatpay.jpg"><img loading="lazy" src="https://cdn.wkyes.com/blog/pay/wechatpay.jpg" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>NicknamedCoco</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://wkyes.com/2022/01/14/%E8%81%8A%E8%81%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E4%B8%80/" title="聊聊多线程(一)">https://wkyes.com/2022/01/14/%E8%81%8A%E8%81%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E4%B8%80/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2022/02/14/%E8%81%8A%E8%81%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E4%BA%8C/" rel="prev" title="聊聊多线程(二)"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">聊聊多线程(二)</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2022/01/02/%E8%8B%A5%E4%BE%9D%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B9%8B%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/" rel="next" title="若依微服务之权限管理"><span class="post-nav-text">若依微服务之权限管理</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>欢迎留下你的脚印~</span><br></div><div id="waline"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@waline/client@v2/dist/waline.css"><script>window.CONFIG.waline.config.path = "/2022/01/14/%E8%81%8A%E8%81%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E4%B8%80/"</script><div class="js-Pjax"><script src="/js/comments/waline.js" type="module" defer></script></div></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">赣ICP备2025057091号</a></div><div class="copyright"><span>&copy; 2019 – 2025 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> NicknamedCoco</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v6.2.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.10.2</span></div><div class="live-time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2020-09-22T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} 天 ${passHour} 小时 ${passMinute} 分 ${passSecond} 秒`;
}
blog_live_time();
</script></div><div class="footer-support"><span>本网站由</span><a class="footer-support-logo" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" target="blank" title="又拍云"><img height="30" src="https://cdn.yunyoujun.cn/img/logo/upyun-logo.png" alt="又拍云"></a><span>提供 CDN 加速/云存储服务</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div class="search-result-container"></div></div></body></html>